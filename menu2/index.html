<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/jemdoc.css"> <link rel=icon  href="/assets/favicon.png"> <title>MPI in Julia</title> <main class=outside > <div class=box > <aside class=layout-menu > <div class=menu-category >Julia in HPC</div> <div class="menu-item "><a href="/">Home</a></div> <div class=menu-category >topics</div> <div class="menu-item "><a href="/menu1/">Functional programming</a></div> <div class="menu-item current"><a href="/menu2/">MPI in Julia</a></div> <div class="menu-item "><a href="/menu3/">CUDA in Julia</a></div> <div class="menu-item "><a href="/menu4/">CUDA-aware MPI</a></div> <div class="menu-item "><a href="/menu5/">MAGMA.jl</a></div> </aside> <div class=layout-content > <div class=franklin-content > <h1 id=mpi_in_julia ><a href="#mpi_in_julia" class=header-anchor >MPI in Julia</a></h1> <div class=franklin-toc ><ol><li><a href="#mpijl">MPI.jl</a><li><a href="#basic_functions">Basic functions</a><li><a href="#lower-case_functions">&quot;Lower-case&quot; functions</a><li><a href="#type_stability">Type stability</a><li><a href="#type-stable_way_to_use_conditional_branches_for_rank">Type-stable way to use conditional branches for <code>rank</code></a><li><a href="#load_balancing">Load balancing</a></ol></div> <h2 id=mpijl ><a href="#mpijl" class=header-anchor >MPI.jl</a></h2> <p>MPI is a message passing API for the distributed memory parallelization. MPI has many implimentations, such as Intel MPI, Open MPI, etc. One of the advantage of MPI.jl is that it supports various implimantations of MPI flexibly, and it is easy to use MPI from Julia by preparing functions with almost the same name as C functions, such as <code>MPI.Send</code>. Additionally MPI.jl offers a simplified version <code>MPI.send</code> which internally serialize the Julia object.</p> <p>MPI.jl also supports the hybrid parallelization. You can request the thread-safe level during the initialization. Essentially, you can write a code with both MPI parallelization and Julia parallelization. MPI.jl also supports CUDA-aware MPI.</p> <h2 id=basic_functions ><a href="#basic_functions" class=header-anchor >Basic functions</a></h2> <h2 id=lower-case_functions ><a href="#lower-case_functions" class=header-anchor >&quot;Lower-case&quot; functions</a></h2> <h2 id=type_stability ><a href="#type_stability" class=header-anchor >Type stability</a></h2> <h2 id=type-stable_way_to_use_conditional_branches_for_rank ><a href="#type-stable_way_to_use_conditional_branches_for_rank" class=header-anchor >Type-stable way to use conditional branches for <code>rank</code></a></h2> <p>Sometimes the conditional branch for <code>rank</code> causes unavoidable type instability. In principle, you can always solve this problem in the following way:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> MPI

<span class=hljs-keyword >function</span> func(::<span class=hljs-built_in >Val</span>{rank}) <span class=hljs-keyword >where</span> rank
    <span class=hljs-keyword >if</span> rank == <span class=hljs-number >0</span>
        <span class=hljs-comment ># job for root</span>
    <span class=hljs-keyword >elseif</span> rank == <span class=hljs-number >1</span>
        <span class=hljs-comment ># job for rank 1</span>
    <span class=hljs-keyword >elseif</span> rank == <span class=hljs-number >2</span>
        <span class=hljs-comment ># job for rank 2</span>
    <span class=hljs-keyword >elseif</span> rank == <span class=hljs-number >3</span>
        <span class=hljs-comment ># job for rank 3</span>
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span>

MPI.Init()

comm = MPI.COMM_WORLD
rank = MPI.Comm_rank(comm)
func(<span class=hljs-built_in >Val</span>(rank))

MPI.Finalize()</code></pre> <p>Or it is better to write in the following way as suggested by <a href="https://docs.julialang.org/en/v1/manual/performance-tips/#Break-functions-into-multiple-definitions">the official document</a>:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> MPI

<span class=hljs-keyword >function</span> func(::<span class=hljs-built_in >Val</span>{<span class=hljs-number >0</span>})
    <span class=hljs-comment ># job for root</span>
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >function</span> func(::<span class=hljs-built_in >Val</span>{<span class=hljs-number >1</span>})
    <span class=hljs-comment ># job for rank 1</span>
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >function</span> func(::<span class=hljs-built_in >Val</span>{<span class=hljs-number >2</span>})
    <span class=hljs-comment ># job for rank 2</span>
<span class=hljs-keyword >end</span>

<span class=hljs-keyword >function</span> func(::<span class=hljs-built_in >Val</span>{<span class=hljs-number >3</span>})
    <span class=hljs-comment ># job for rank 3</span>
<span class=hljs-keyword >end</span>

MPI.Init()

comm = MPI.COMM_WORLD
rank = MPI.Comm_rank(comm)
func(<span class=hljs-built_in >Val</span>(rank))

MPI.Finalize()</code></pre> <p>This is how to work around. In either case, the JIT compiler will compile a necessary part of your code.</p> <h2 id=load_balancing ><a href="#load_balancing" class=header-anchor >Load balancing</a></h2> <div class=page-foot > <div class=copyright > &copy; Masahiko G. Yamada. Last modified: September 19, 2021. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> </div> </main>